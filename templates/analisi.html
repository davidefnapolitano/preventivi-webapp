<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Analisi Energetica</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; color:#333; padding:20px; }
    .container { max-width:700px; margin:0 auto; background:#fff; border-radius:8px; padding:20px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
    h1 { text-align:center; margin-bottom:20px; color:#2c7873; }
    label { display:block; margin-top:15px; font-weight:bold; }
    input { width:100%; padding:8px; margin-top:5px; border:1px solid #ccc; border-radius:4px; font-size:1rem; }
    button { margin-top:20px; width:100%; padding:12px; background:#2c7873; color:white; border:none; border-radius:4px; font-size:1rem; cursor:pointer; }
    button:hover { background:#235d59; }
    table { width:100%; margin-top:20px; border-collapse:collapse; }
    th, td { padding:8px; border-bottom:1px solid #ddd; text-align:right; }
    th { background:#2c7873; color:white; text-align:center; }
    canvas { margin-top:30px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="container" data-kw="{{ kw }}">
    <h1>Analisi Energetica</h1>
    <p>Potenza Impianto: <strong id="kw-val"></strong> kW</p>
    <label for="lat">Latitudine</label>
    <input type="number" step="0.0001" id="lat" placeholder="es. 45.07" />
    <label for="lon">Longitudine</label>
    <input type="number" step="0.0001" id="lon" placeholder="es. 7.68" />
    <label for="azimuth">Orientamento impianto (0° Nord, 90° Est, 180° Sud)</label>
    <input type="number" step="1" id="azimuth" />
    <label for="tilt">Inclinazione impianto (gradi)</label>
    <input type="number" step="1" id="tilt" />
    <button id="analizza-btn">Analizza</button>

    <table id="result-table" class="hidden">
      <thead>
        <tr><th>Mese</th><th>Produzione kWh</th></tr>
      </thead>
      <tbody id="result-body"></tbody>
      <tfoot>
        <tr><th>Totale</th><th id="total-val"></th></tr>
      </tfoot>
    </table>
    <canvas id="chart" width="600" height="300" class="hidden"></canvas>
  </div>

<script>
const kw = parseFloat(document.querySelector('.container').dataset.kw) || 1;
document.getElementById('kw-val').textContent = kw.toFixed(2);
const mesi = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
let chart = new Chart(document.getElementById('chart'), {
  type: 'bar',
  data: { labels: mesi, datasets: [{ label: 'kWh', backgroundColor:'#ff9a3c', data: [] }] },
  options: { scales:{ y:{ beginAtZero:true } } }
});

function show(el){ el.classList.remove('hidden'); }
function hide(el){ el.classList.add('hidden'); }

document.getElementById('analizza-btn').addEventListener('click', () => {
  const lat = parseFloat(document.getElementById('lat').value);
  const lon = parseFloat(document.getElementById('lon').value);
  const az = parseFloat(document.getElementById('azimuth').value);
  const tilt = parseFloat(document.getElementById('tilt').value);
  fetch('/api/analisi', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({lat, lon, azimuth:az, tilt, kw})
  })
  .then(r => { if(!r.ok) throw new Error('Errore server'); return r.json(); })
  .then(data => {
    const tbody = document.getElementById('result-body');
    tbody.innerHTML='';
    let tot=0;
    data.monthly.forEach((val,i)=>{
      const tr=document.createElement('tr');
      const tm=document.createElement('td'); tm.textContent=mesi[i]; tm.style.textAlign='center';
      const tv=document.createElement('td'); tv.textContent=val.toFixed(2);
      tr.appendChild(tm); tr.appendChild(tv); tbody.appendChild(tr);
      tot+=val;
    });
    document.getElementById('total-val').textContent=tot.toFixed(2);
    chart.data.datasets[0].data = data.monthly;
    chart.update();
    show(document.getElementById('result-table'));
    show(document.getElementById('chart'));
  })
  .catch(err => alert(err));
});
</script>
</body>
</html>
